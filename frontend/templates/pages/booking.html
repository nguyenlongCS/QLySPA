{% extends 'layouts/base.html' %}

{% block title %}Đặt Lịch | OU Spa{% endblock %}

{% block page_css %}
<style>
/* Header style cho booking page */
.booking-page header nav {
    padding: 8px 30px;
}
.booking-page header {
    background: #eee2ca;
    position: sticky;
    top: 0px;
    z-index: 999;
    height: 100px;
}

.booking-page header nav a {
    color: #222 !important;
}

.booking-page header nav a:hover {
    color: #c8a24a;
}

.booking-page header nav a::after {
    content: "";
    position: absolute;
    left: 50%;
    bottom: -3px;
    width: 0;
    height: 1px;
    background: #0e0e0e;
    transform: translateX(-50%);
    transition: width 0.2s ease;
    pointer-events: none;
}

.booking-page .btn-primary {
    background: transparent;
    color: #222;
    border: 1px solid #222;
}

.booking-page .btn-primary:hover {
    background: #c8a24a;
    color: #fff;
    border-color: #c8a24a;
}

/* Container styling */
.booking-container {
    max-width: 1000px;
    margin: 80px auto 60px;
    padding: 40px;
    background: #f9f9f9;
    border-radius: 8px;
}

.booking-container h1 {
    text-align: center;
    font-size: 36px;
    margin-bottom: 10px;
    color: #333;
}

.booking-container p {
    text-align: center;
    margin-bottom: 30px;
    color: #666;
}

/* Tab Navigation */
.tab-nav {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
    border-bottom: 1px solid #ddd;
}

.tab-btn {
    background: none;
    border: none;
    padding: 15px 30px;
    font-size: 16px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
}

.tab-btn.active {
    color: #c8a165;
    border-bottom-color: #c8a165;
    font-weight: 600;
}

.tab-btn:hover {
    color: #c8a165;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Form styles */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #c8a165;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 8px;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: normal;
}

button[type="submit"] {
    width: 100%;
    padding: 15px;
    background: #c8a165;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
}

button[type="submit"]:hover {
    background: #b8944f;
}

button[type="submit"]:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.error-message {
    color: #e53935;
    font-size: 12px;
    margin-top: 4px;
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    border: 1px solid #c3e6cb;
}

.login-required {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
    margin: 40px 0;
}

.login-required h3 {
    color: #856404;
    margin-bottom: 15px;
}

.login-required p {
    color: #856404;
    margin-bottom: 20px;
}

.btn-auth {
    display: inline-block;
    background: #c8a165;
    color: white;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
}

.btn-auth:hover {
    background: #b8944f;
    color: white;
}

/* Booking list styles */
.booking-list {
    margin-top: 20px;
}

.booking-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.booking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.booking-id {
    font-weight: 600;
    color: #333;
    margin-right: 20px;
}

.booking-status {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.status-confirmed {
    background: #d4edda;
    color: #155724;
}

.status-accepted {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.booking-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.booking-field {
    font-size: 14px;
}

.booking-field strong {
    display: block;
    color: #333;
    margin-bottom: 5px;
}

.booking-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-cancel {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-cancel:hover {
    background: #c82333;
}

.btn-cancel:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.no-bookings {
    text-align: center;
    color: #666;
    padding: 40px;
    background: white;
    border-radius: 8px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .tab-nav {
        flex-direction: column;
    }

    .booking-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .booking-details {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block body_class %}booking-page{% endblock %}

{% block content %}
<section class="booking-container">
    <h1>ĐẶT LỊCH</h1>
    <p>Chỉ một bước đặt lịch, bạn sẽ có ngay trải nghiệm tuyệt vời tại OU Spa.</p>

    <div id="success-message" class="success-message" style="display: none;"></div>

    <!-- Thông báo yêu cầu đăng nhập -->
    <div id="login-required" class="login-required">
        <h3>Vui lòng đăng nhập để sử dụng dịch vụ đặt lịch</h3>
        <p>Để đảm bảo thông tin đặt lịch chính xác và quản lý lịch hẹn của bạn, vui lòng đăng nhập trước.</p>
        <a href="{{ url_for('login') }}?return={{ url_for('booking') }}" class="btn-auth">Đăng nhập ngay</a>
        <p style="margin-top: 15px;">Chưa có tài khoản? <a href="{{ url_for('register') }}">Đăng ký tại đây</a></p>
    </div>

    <!-- Tab navigation - chỉ hiển thị khi đã đăng nhập -->
    <div id="user-content" style="display: none;">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('new-booking')">Đặt Lịch Mới</button>
            <button class="tab-btn" onclick="showTab('current-bookings')">Lịch Hiện Tại</button>
            <button class="tab-btn" onclick="showTab('booking-history')">Lịch Sử</button>
        </div>

        <!-- Tab: Đặt lịch mới -->
        <div id="new-booking" class="tab-content active">
            <form id="spaBookingForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Họ tên *</label>
                        <input type="text" id="name" name="name" required placeholder="Nhập họ tên của bạn">
                        <div class="error-message" id="name-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="phone">Số điện thoại *</label>
                        <input type="tel" id="phone" name="phone" required pattern="[0-9]{9,11}" placeholder="Số điện thoại từ 9-11 số">
                        <div class="error-message" id="phone-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Địa chỉ email (không bắt buộc)">
                    <div class="error-message" id="email-error"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="servicesId">Dịch vụ *</label>
                        <select id="servicesId" name="servicesId" required>
                            <option value="">-- Chọn dịch vụ --</option>
                        </select>
                        <div class="error-message" id="service-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="employeeId">Kỹ thuật viên *</label>
                        <select id="employeeId" name="employeeId" required>
                            <option value="">-- Chọn nhân viên --</option>
                        </select>
                        <div class="error-message" id="employee-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bookingDate">Ngày đặt *</label>
                        <input type="date" id="bookingDate" required>
                        <div class="error-message" id="date-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="bookingTime">Thời gian *</label>
                        <select id="bookingTime" name="bookingTime" required>
                            <option value="">-- Chọn thời gian --</option>
                            <option value="07:00:00">07:00</option>
                            <option value="08:00:00">08:00</option>
                            <option value="09:00:00">09:00</option>
                            <option value="10:00:00">10:00</option>
                            <option value="11:00:00">11:00</option>
                            <option value="12:00:00">12:00</option>
                            <option value="13:00:00">13:00</option>
                            <option value="14:00:00">14:00</option>
                            <option value="15:00:00">15:00</option>
                            <option value="16:00:00">16:00</option>
                            <option value="17:00:00">17:00</option>
                            <option value="18:00:00">18:00</option>
                            <option value="19:00:00">19:00</option>
                            <option value="20:00:00">20:00</option>
                            <option value="21:00:00">21:00</option>
                            <option value="22:00:00">22:00</option>
                            <option value="custom">Nhập</option>
                        </select>

                        <input type="text" id="customTime" name="customTime"
                               placeholder="VD: 07:30, 15:45"
                               style="display: none; margin-top: 8px;"
                               pattern="^([0-1]?[0-9]|2[0-2]):[0-5][0-9]$">

                        <small style="color: #666; font-size: 12px;">Giờ hoạt động: 7:00 - 22:00</small>
                        <div class="error-message" id="time-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Bạn đã từng đến Spa chưa?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="old_customer" value="yes"> Có</label>
                        <label><input type="radio" name="old_customer" value="no"> Chưa</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="note">Yêu cầu bổ sung</label>
                    <textarea id="note" name="note" rows="3" placeholder="Ví dụ: Yêu cầu kỹ thuật viên nam/nữ, phòng yên tĩnh..."></textarea>
                </div>

                <button type="submit" id="submitBtn">ĐẶT LỊCH</button>
            </form>
        </div>

        <!-- Tab: Lịch hiện tại -->
        <div id="current-bookings" class="tab-content">
            <div class="booking-list" id="current-booking-list">
                <div class="no-bookings">Đang tải...</div>
            </div>
        </div>

        <!-- Tab: Lịch sử -->
        <div id="booking-history" class="tab-content">
            <div class="booking-list" id="history-booking-list">
                <div class="no-bookings">Đang tải...</div>
            </div>
        </div>
    </div>
</section>

<script>
const API_BASE_URL = 'http://127.0.0.1:5000/api';
let currentUser = null;

document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
});

function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const userInfo = localStorage.getItem('userInfo');

    if (!isLoggedIn || !userInfo) {
        document.getElementById('login-required').style.display = 'block';
        document.getElementById('user-content').style.display = 'none';
        return;
    }

    try {
        currentUser = JSON.parse(userInfo);

        // Tự động điền thông tin vào form
        document.getElementById('name').value = currentUser.name || '';
        document.getElementById('phone').value = currentUser.phone || '';
        document.getElementById('email').value = currentUser.email || '';

        // Chuyển hướng theo role
        if (currentUser.role === 'Employee') {
            window.location.href = '/employee';
            return;
        }

        if (currentUser.role === 'Admin') {
            window.location.href = '/admin';
            return;
        }

        // Chỉ Customer mới được ở lại trang này
        if (currentUser.role !== 'Customer') {
            alert('Trang này chỉ dành cho khách hàng');
            logout();
            return;
        }

        // Hiển thị content và ẩn thông báo đăng nhập
        document.getElementById('login-required').style.display = 'none';
        document.getElementById('user-content').style.display = 'block';

        // Load dữ liệu cho form
        loadServices();
        loadEmployees();
        setupTimeSelection();

        // Đặt ngày tối thiểu là ngày hôm nay
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('bookingDate').min = today;

        // Load booking data
        loadCurrentBookings();
        loadBookingHistory();

    } catch (error) {
        console.error('Lỗi parse user info:', error);
        logout();
    }
}

function showTab(tabName) {
    // Ẩn tất cả tab content
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));

    // Bỏ active cho tất cả tab buttons
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));

    // Hiển thị tab được chọn
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    // Load data tương ứng
    if (tabName === 'current-bookings') {
        loadCurrentBookings();
    } else if (tabName === 'booking-history') {
        loadBookingHistory();
    }
}

// Load danh sách dịch vụ
async function loadServices() {
    try {
        const response = await fetch(`${API_BASE_URL}/services`);
        const result = await response.json();

        if (result.success) {
            const serviceSelect = document.getElementById('servicesId');
            serviceSelect.innerHTML = '<option value="">-- Chọn dịch vụ --</option>';

            result.data.forEach(service => {
                const option = document.createElement('option');
                option.value = service.servicesId;
                option.textContent = `${service.name} (${service.durration} phút - ${service.price.toLocaleString()}đ)`;
                serviceSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Lỗi khi tải dịch vụ:', error);
    }
}

// Load danh sách nhân viên
async function loadEmployees() {
    try {
        const response = await fetch(`${API_BASE_URL}/employees`);
        const result = await response.json();

        if (result.success) {
            const employeeSelect = document.getElementById('employeeId');
            employeeSelect.innerHTML = '<option value="">-- Chọn nhân viên --</option>';

            result.data.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.employeeId;
                option.textContent = employee.name;
                employeeSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Lỗi khi tải nhân viên:', error);
    }
}

// Setup time selection
function setupTimeSelection() {
    const timeSelect = document.getElementById('bookingTime');
    const customTimeInput = document.getElementById('customTime');

    timeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customTimeInput.style.display = 'block';
            customTimeInput.required = true;
            this.required = false;
            customTimeInput.focus();
        } else {
            customTimeInput.style.display = 'none';
            customTimeInput.required = false;
            this.required = true;
            customTimeInput.value = '';
            clearError('time-error');
        }
    });

    customTimeInput.addEventListener('input', function() {
        const timeValue = this.value.trim();
        if (timeValue) {
            const timePattern = /^([0-1]?[0-9]|2[0-2]):([0-5][0-9])$/;
            if (timePattern.test(timeValue)) {
                const [hours, minutes] = timeValue.split(':').map(Number);
                if (hours >= 7 && hours <= 22) {
                    clearError('time-error');
                } else {
                    showError('time-error', 'Thời gian phải từ 7:00 đến 22:00');
                }
            } else {
                showError('time-error', 'Định dạng thời gian không đúng (VD: 07:30)');
            }
        }
    });
}

// Load lịch hiện tại
async function loadCurrentBookings() {
    try {
        const response = await fetch(`${API_BASE_URL}/bookings`);
        const result = await response.json();

        if (result.success) {
            const currentBookings = result.data.filter(booking => {
                const bookingTime = new Date(booking.time);
                const now = new Date();
                return bookingTime >= now &&
                       booking.status !== 'Đã hủy' &&
                       booking.customer.customerId === currentUser.customerId;
            });

            displayBookings(currentBookings, 'current-booking-list', true);
        }
    } catch (error) {
        console.error('Lỗi khi tải lịch hiện tại:', error);
        document.getElementById('current-booking-list').innerHTML = '<div class="no-bookings">Có lỗi xảy ra</div>';
    }
}

// Load lịch sử
async function loadBookingHistory() {
    try {
        const response = await fetch(`${API_BASE_URL}/bookings`);
        const result = await response.json();

        if (result.success) {
            const pastBookings = result.data.filter(booking => {
                const bookingTime = new Date(booking.time);
                const now = new Date();
                return bookingTime < now &&
                       booking.customer.customerId === currentUser.customerId;
            });

            displayBookings(pastBookings, 'history-booking-list', false);
        }
    } catch (error) {
        console.error('Lỗi khi tải lịch sử:', error);
        document.getElementById('history-booking-list').innerHTML = '<div class="no-bookings">Có lỗi xảy ra</div>';
    }
}

// Hiển thị danh sách booking
function displayBookings(bookings, containerId, showCancelButton = false) {
    const container = document.getElementById(containerId);

    if (bookings.length === 0) {
        container.innerHTML = '<div class="no-bookings">Không có lịch đặt nào.</div>';
        return;
    }

    const html = bookings.map(booking => {
        const bookingTime = new Date(booking.time);
        const formattedDate = bookingTime.toLocaleDateString('vi-VN');
        const formattedTime = bookingTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

        let statusClass = 'status-confirmed';
        if (booking.status === 'Đang chờ') statusClass = 'status-pending';
        if (booking.status === 'Chấp nhận') statusClass = 'status-accepted';
        if (booking.status === 'Từ chối') statusClass = 'status-rejected';
        if (booking.status === 'Đã hủy') statusClass = 'status-cancelled';

        const canCancel = showCancelButton &&
                         (booking.status === 'Đang chờ' || booking.status === 'Chấp nhận') &&
                         bookingTime > new Date();

        return `
            <div class="booking-item">
                <div class="booking-header">
                    <span class="booking-id">Mã: ${booking.bookingId}</span>
                    <span class="booking-status ${statusClass}">${booking.status}</span>
                </div>
                <div class="booking-details">
                    <div class="booking-field">
                        <strong>Kỹ thuật viên:</strong>
                        ${booking.employee.name}
                    </div>
                    <div class="booking-field">
                        <strong>Dịch vụ:</strong>
                        ${booking.service.name}
                    </div>
                    <div class="booking-field">
                        <strong>Ngày:</strong>
                        ${formattedDate}
                    </div>
                    <div class="booking-field">
                        <strong>Giờ:</strong>
                        ${formattedTime}
                    </div>
                </div>
                ${canCancel ? `
                    <div class="booking-actions">
                        <button class="btn-cancel" onclick="cancelBooking('${booking.bookingId}')">Hủy lịch</button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// Hủy booking
async function cancelBooking(bookingId) {
    if (!confirm('Bạn có chắc muốn hủy lịch đặt này?')) return;

    try {
        const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'Đã hủy' })
        });

        const result = await response.json();
        if (result.success) {
            showSuccess('Hủy lịch thành công!');
            loadCurrentBookings(); // Reload danh sách
        } else {
            alert('Có lỗi xảy ra: ' + result.message);
        }
    } catch (error) {
        console.error('Lỗi hủy lịch:', error);
        alert('Có lỗi xảy ra khi hủy lịch');
    }
}

// Xử lý submit form đặt lịch
document.getElementById('spaBookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!currentUser || !currentUser.customerId) {
        alert('Vui lòng đăng nhập để đặt lịch');
        return;
    }

    clearErrors();
    if (!validateForm()) {
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Đang xử lý...';

    try {
        await createBooking(currentUser.customerId);
    } catch (error) {
        console.error('Lỗi:', error);
        alert('Có lỗi xảy ra: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ĐẶT LỊCH';
    }
});

// Tạo booking
async function createBooking(baseCustomerId) {
    // Cập nhật thông tin customer
    try {
        await fetch(`${API_BASE_URL}/customers/${baseCustomerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim()
            })
        });
    } catch (error) {
        console.log('Lỗi cập nhật customer:', error);
    }

    const date = document.getElementById('bookingDate').value;
    const finalTime = document.getElementById('bookingTime').getAttribute('data-final-time');
    const fullDateTime = `${date}T${finalTime}`;

    const bookingData = {
        bookingId: 'BK' + Date.now().toString().slice(-8),
        customerId: baseCustomerId,
        servicesId: document.getElementById('servicesId').value,
        employeeId: document.getElementById('employeeId').value,
        time: fullDateTime,
        status: 'Đang chờ'
    };

    const response = await fetch(`${API_BASE_URL}/bookings`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(bookingData)
    });

    const result = await response.json();
    if (!result.success) {
        throw new Error(result.message || 'Không thể đặt lịch');
    }

    showSuccess('Đặt lịch thành công! Lịch của bạn đang chờ admin xác nhận.');

    // Reset form
    resetBookingForm();

    // Reload current bookings
    loadCurrentBookings();
}

// Reset form đặt lịch
function resetBookingForm() {
    document.getElementById('servicesId').value = '';
    document.getElementById('employeeId').value = '';
    document.getElementById('bookingDate').value = '';
    document.getElementById('bookingTime').value = '';
    document.getElementById('customTime').value = '';
    document.getElementById('customTime').style.display = 'none';
    document.getElementById('bookingTime').required = true;
    document.getElementById('customTime').required = false;
    if (document.getElementById('note')) {
        document.getElementById('note').value = '';
    }

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').min = today;
}

// Validate form
function validateForm() {
    let isValid = true;

    const name = document.getElementById('name').value.trim();
    if (!name) {
        showError('name-error', 'Vui lòng nhập họ tên');
        isValid = false;
    }

    const phone = document.getElementById('phone').value.trim();
    if (!phone) {
        showError('phone-error', 'Vui lòng nhập số điện thoại');
        isValid = false;
    } else if (!/^\d{9,11}$/.test(phone)) {
        showError('phone-error', 'Số điện thoại phải có 9-11 chữ số');
        isValid = false;
    }

    if (!document.getElementById('servicesId').value) {
        showError('service-error', 'Vui lòng chọn dịch vụ');
        isValid = false;
    }

    if (!document.getElementById('employeeId').value) {
        showError('employee-error', 'Vui lòng chọn kỹ thuật viên');
        isValid = false;
    }

    const bookingDate = document.getElementById('bookingDate').value;
    if (!bookingDate) {
        showError('date-error', 'Vui lòng chọn ngày đặt lịch');
        isValid = false;
    } else {
        const selectedDate = new Date(bookingDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
            showError('date-error', 'Không thể đặt lịch trong quá khứ');
            isValid = false;
        }
    }

    const timeSelect = document.getElementById('bookingTime');
    const customTimeInput = document.getElementById('customTime');
    let finalTime = null;

    if (timeSelect.value === 'custom') {
        const customTime = customTimeInput.value.trim();
        if (!customTime) {
            showError('time-error', 'Vui lòng nhập thời gian');
            isValid = false;
        } else {
            const timePattern = /^([0-1]?[0-9]|2[0-2]):([0-5][0-9])$/;
            if (!timePattern.test(customTime)) {
                showError('time-error', 'Định dạng thời gian không đúng (VD: 07:30)');
                isValid = false;
            } else {
                const [hours, minutes] = customTime.split(':').map(Number);
                if (hours < 7 || hours > 22) {
                    showError('time-error', 'Thời gian phải từ 7:00 đến 22:00');
                    isValid = false;
                } else {
                    finalTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00`;
                }
            }
        }
    } else {
        if (!timeSelect.value) {
            showError('time-error', 'Vui lòng chọn thời gian');
            isValid = false;
        } else {
            finalTime = timeSelect.value;
        }
    }

    if (finalTime) {
        document.getElementById('bookingTime').setAttribute('data-final-time', finalTime);
    }

    return isValid;
}

// Helper functions
function showError(elementId, message) {
    document.getElementById(elementId).textContent = message;
}

function clearError(elementId) {
    document.getElementById(elementId).textContent = '';
}

function clearErrors() {
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(el => el.textContent = '');
}

function showSuccess(message) {
    const successEl = document.getElementById('success-message');
    successEl.textContent = message;
    successEl.style.display = 'block';

    window.scrollTo({ top: 0, behavior: 'smooth' });

    setTimeout(() => {
        successEl.style.display = 'none';
    }, 5000);
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userInfo');
    currentUser = null;
    window.location.reload();
}
</script>
{% endblock %}